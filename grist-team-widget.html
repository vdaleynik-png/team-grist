<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team Directory — Grist Widget</title>

  <!-- Grist Plugin API (branch) -->
  <script src="https://vn-branch.getgrist.com/grist-plugin-api.js"></script>

  <!-- Font (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1116; --text:#e7ecf2; --muted:#8b96a9;
      --selection: rgba(22,179,120,.15);
      --fade-dur:420ms; --fade-ease:cubic-bezier(.2,.8,.2,1); --fade-stagger:60ms;
      --hover-dur:180ms; --grid-size:72px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:#0f1116;overflow-x:hidden}
    body::after{content:"";position:fixed;inset:-15%;z-index:-3;pointer-events:none;background:
      radial-gradient(1100px 720px at 110% -10%, rgba(22,179,120,.14), transparent 60%),
      radial-gradient(900px 600px at -8% 120%, rgba(22,179,120,.10), transparent 60%);
      filter:blur(18px);animation:parallax 160s linear infinite}
    @keyframes parallax{0%{transform:translate3d(0,0,0) rotate(0) scale(1.02)}50%{transform:translate3d(12px,-8px,0) rotate(180deg) scale(1.02)}100%{transform:translate3d(0,0,0) rotate(360deg) scale(1.02)}}
    body::before{content:"";position:fixed;inset:-10%;z-index:-2;pointer-events:none;background:
      repeating-linear-gradient(0deg, rgba(255,255,255,.028) 0 1px, transparent 1px var(--grid-size)),
      repeating-linear-gradient(90deg, rgba(255,255,255,.030) 0 1px, transparent 1px var(--grid-size));
      background-size:var(--grid-size) var(--grid-size);animation:gridDrift 120s linear infinite}
    @keyframes gridDrift{0%{background-position:0 0,0 0}100%{background-position:0 calc(-1 * var(--grid-size)), calc(-1 * var(--grid-size)) 0}}
    .wrapper{max-width:1100px;margin:0 auto;padding:28px 20px 40px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .title{font-size:22px;font-weight:700;letter-spacing:.2px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .card{grid-column:span 12;position:relative;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));border:1px solid #232a37;border-radius:18px;padding:18px;opacity:0;animation:fadeIn var(--fade-dur) var(--fade-ease) both;transition:background var(--hover-dur) ease, border-color var(--hover-dur) ease;contain:content}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .card:hover{background:linear-gradient(180deg, rgba(22,179,120,.06), rgba(61,217,163,.02));border-color:#2d3647}
    .row{display:grid;grid-template-columns:1.6fr 1.4fr auto;align-items:center;gap:12px}
    .name{font-weight:600;font-size:16px}
    .role{color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:8px;background:rgba(22,179,120,.14);color:#b9ffe7;border:1px solid rgba(22,179,120,.42);padding:8px 11px;border-radius:999px;font-weight:600;font-size:13px;text-decoration:none;transition:background var(--hover-dur) ease,border-color var(--hover-dur) ease}
    .badge:hover{background:rgba(22,179,120,.18);border-color:rgba(22,179,120,.52)}
    .badge:focus-visible{outline:0;box-shadow:0 0 0 6px var(--selection)}
    .ext{width:16px;height:16px;display:inline-block}
    @media (min-width:700px){.card{grid-column:span 6}}
    @media (min-width:980px){.card{grid-column:span 4}}
    .empty{opacity:.8;color:var(--muted);text-align:center;padding:26px}
    @media (prefers-reduced-motion:reduce){body::after,body::before{animation:none!important}.card{animation:none!important;opacity:1!important}.badge,.card{transition:none!important}}
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="topbar"><div class="title">Team directory</div></div>
    <div id="grid" class="grid" aria-live="polite"></div>
  </div>

  <template id="cardTpl">
    <div class="card">
      <div class="row">
        <div class="name"></div>
        <div class="role"></div>
        <a class="badge" href="#" aria-label="Open workspace">
          <svg class="ext" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M18 13v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
            <polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/>
          </svg>
          <span class="badge-text">Open workspace</span>
        </a>
      </div>
    </div>
  </template>

  <script>
  // ------- Config -------
  const CONFIG = {
    columns: { name: 'Staff', role: 'Role', link: 'Workspace' }, // берем ссылку из $Workspace
    renderChunk: 60
  };

  // ------- Utils -------
  const $ = (s, r=document) => r.querySelector(s);
  const gridEl = $('#grid');
  const tpl = $('#cardTpl');
  const normalizeId = (s) => (s||'').toString().replace(/^\$/,'');
  const cache = new Map();

  const ALLOWED_HOST = 'vn-branch.getgrist.com';
  const ALLOWED_PATH_RE = /^\/[A-Za-z0-9]+\/[^/]+\/p\/\d+$/;  // /docId/Page/p/num
  const RE_MD = /\[[^\]]*\]\(([^)]+)\)/;
  const RE_HREF = /href\s*=\s*["']([^"']+)["']/i;

  function strictGristUrl(u){
    try{
      const url = new URL(u);
      if (url.hostname !== ALLOWED_HOST) return '';
      if (!ALLOWED_PATH_RE.test(url.pathname)) return '';
      url.hash = '';
      // оставить только style, всё остальное убрать
      for (const k of Array.from(url.searchParams.keys())) {
        if (k.toLowerCase() !== 'style') url.searchParams.delete(k);
      }
      url.searchParams.set('style','singlePage');
      return url.toString();
    }catch{ return ''; }
  }

  function sanitize(raw){
    if (!raw) return '';
    if (cache.has(raw)) return cache.get(raw);
    let u = String(raw).trim();
    u = u.replace(/^(https?):\/(?!\/)/i, (_,p)=>`${p}://`);         // https:/ -> https://
    if (!/^[a-z][a-z0-9+.-]*:\/\//i.test(u)) u = 'https://' + u;    // без схемы -> https://
    if (/^\s*(javascript|data):/i.test(u)) { cache.set(raw,''); return ''; }
    const out = strictGristUrl(u);
    cache.set(raw,out);
    return out;
  }

  function extractUrl(val){
    if (!val) return '';
    if (typeof val === 'object') return sanitize(val.url || val.href || val.link || '');
    const s = String(val).trim();
    const md = s.match(RE_MD); if (md && md[1]) return sanitize(md[1]);
    const ah = s.match(RE_HREF); if (ah && ah[1]) return sanitize(ah[1]);
    return sanitize(s);
  }

  function openLink(u){
    if(!u) return;
    try{
      if (new URL(u).hostname === ALLOWED_HOST && window.top) {
        window.top.location.assign(u); return;
      }
    }catch{}
    window.open(u, '_blank', 'noopener');
  }

  function resolveColumns(all){
    const keys = all.map(k => k.toString());
    const lower = new Map(keys.map(k => [k.toLowerCase(), k]));
    const want = {
      name: normalizeId(CONFIG.columns.name).toLowerCase(),
      role: normalizeId(CONFIG.columns.role).toLowerCase(),
      link: normalizeId(CONFIG.columns.link).toLowerCase()
    };
    const pick = (target, cands) => {
      if (lower.has(target)) return lower.get(target);
      for (const c of cands){
        const lc = c.toLowerCase();
        if (lower.has(lc)) return lower.get(lc);
        for (const k of lower.keys()) if (k.includes(lc)) return lower.get(k);
      }
      return null;
    };
    return {
      name: pick(want.name, ['staff','name','employee']),
      role: pick(want.role, ['role','title','position']),
      link: pick(want.link, ['workspace','workspace_url','workspace_link','link','url'])
    };
  }

  function mapRow(row, cols){
    const src = row.fields || row;
    return {
      name: src?.[cols.name] ?? '',
      role: src?.[cols.role] ?? '',
      link: extractUrl(src?.[cols.link])
    };
  }

  function render(records){
    gridEl.replaceChildren();
    if (!records?.length) { gridEl.innerHTML = '<div class="empty">No data found</div>'; return; }
    const chunk = Math.max(10, CONFIG.renderChunk|0);
    let i = 0;
    const pump = () => {
      const frag = document.createDocumentFragment();
      for (let c=0; c<chunk && i<records.length; c++, i++){
        const r = records[i];
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.style.setProperty('--delay', `calc(${i} * var(--fade-stagger))`);
        node.querySelector('.name').textContent = r.name || '—';
        node.querySelector('.role').textContent = r.role || '';
        const a = node.querySelector('a.badge');
        if (r.link){
          a.href = r.link;
          a.setAttribute('aria-label', `Open workspace for ${r.name || 'member'}`);
        } else {
          a.classList.add('disabled'); a.href = '#'; a.setAttribute('aria-disabled','true');
          a.querySelector('.badge-text').textContent = 'No URL';
        }
        frag.appendChild(node);
      }
      gridEl.appendChild(frag);
      if (i < records.length) (window.requestIdleCallback || window.requestAnimationFrame)(pump);
    };
    pump();
  }

  gridEl.addEventListener('click', (e)=>{
    const a = e.target.closest('a.badge'); if (!a) return;
    e.preventDefault(); openLink(a.href);
  });

  (function init(){
    if (!window.grist) { render([]); return; }
    grist.ready({requiredAccess: 'read table'});
    grist.onRecords((rows)=>{
      if (!rows?.length) { render([]); return; }
      const cols = resolveColumns(Object.keys((rows[0]||{}).fields || rows[0] || {}));
      if (!cols.link) console.warn('[Team Directory] Column "Workspace" not found — add it to Visible columns.');
      render(rows.map(r => mapRow(r, cols)));
    });
  })();
  </script>
</body>
</html>
