<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grist Staff Directory – Widget</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    :root{
      --bg:#0f1116; --panel:#151922; --panel-2:#1b2230;
      --text:#e7ecf2; --muted:#8b96a9;
      --accent:#3dd9a3; --accent-2:#66f; --ring: rgba(61,217,163,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,Segoe UI,Helvetica,Arial,sans-serif; color:var(--text);
      background:
        radial-gradient(1100px 800px at 110% -10%, rgba(102,102,255,.10), transparent 60%),
        radial-gradient(900px 600px at -8% 120%, rgba(61,217,163,.10), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }
    body::before{
      content:""; position:fixed; inset:-10%; z-index:-1; pointer-events:none;
      background:
        repeating-linear-gradient(0deg,  rgba(255,255,255,.028) 0 1px, transparent 1px 72px),
        repeating-linear-gradient(90deg, rgba(255,255,255,.030) 0 1px, transparent 1px 72px);
      animation: gridDrift 120s linear infinite;
    }
    @keyframes gridDrift{ 0%{background-position:0 0,0 0} 100%{background-position:0 -72px,-72px 0} }

    .wrapper{max-width:1100px; margin:0 auto; padding:28px 20px 40px}
    .topbar{display:flex; gap:14px; align-items:center; justify-content:space-between; margin-bottom:18px}
    .title{font-size:22px; font-weight:700; letter-spacing:.2px}

    .controls{display:flex; gap:10px; flex-wrap:wrap}
    .input, .select{
      background:linear-gradient(180deg, var(--panel), var(--panel-2)); color:var(--text);
      border:1px solid #242b38; border-radius:14px; padding:12px 14px; outline:none; min-width:220px;
      transition:transform .15s ease, box-shadow .15s ease, border-color .2s ease;
    }
    .input::placeholder{color:#a0a9ba}
    .input:focus, .select:focus{ box-shadow:0 0 0 6px var(--ring); border-color:rgba(61,217,163,.55); transform:translateY(-1px)}

    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:14px}
    .card{
      grid-column: span 12;
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      border:1px solid #232a37; border-radius:18px; padding:18px; position:relative; overflow:hidden;
      transition: background .2s ease, border-color .2s ease;
      opacity:0; animation:fadeIn .42s cubic-bezier(.2,.8,.2,1) both;
    }
    @keyframes fadeIn{ from{opacity:0} to{opacity:1} }
    .card:hover{ background:linear-gradient(180deg, rgba(61,217,163,.06), rgba(102,102,255,.02)); border-color:#2d3647 }

    .row{display:grid; grid-template-columns:1.5fr 1.5fr auto; align-items:center; gap:12px}
    .name{font-weight:600; font-size:16px}
    .role{color:var(--muted)}

    .badge{display:inline-flex; align-items:center; gap:8px; background:rgba(61,217,163,.12); color:#b9ffe7; border:1px solid rgba(61,217,163,.35); padding:8px 11px; border-radius:999px; font-weight:600; font-size:13px; text-decoration:none; transition: background .2s ease, border-color .2s ease}
    .badge:hover{ background:rgba(61,217,163,.18); border-color:rgba(61,217,163,.52)}
    .ext{ width:16px; height:16px; display:inline-block; }

    @media (min-width:700px){ .card{ grid-column: span 6 } }
    @media (min-width:980px){ .card{ grid-column: span 4 } }

    .empty{opacity:.8; color:var(--muted); text-align:center; padding:26px}
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="topbar">
      <div class="title">Команда • каталог сотрудников</div>
      <div class="controls">
        <input id="q" class="input" placeholder="Поиск по имени/роли… (⌘/Ctrl + K)" />
        <select id="sort" class="select" title="Сортировка">
          <option value="name">Сортировать: Имя</option>
          <option value="role">Сортировать: Роль</option>
        </select>
      </div>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>
  </div>

  <template id="cardTpl">
    <div class="card">
      <div class="row">
        <div class="name"></div>
        <div class="role"></div>
        <a class="badge" href="#">
          <svg class="ext" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          Открыть workspace
        </a>
      </div>
    </div>
  </template>

  <script>
    const el = (sel, root=document) => root.querySelector(sel);
    const by = (k) => (a,b)=> (a[k]||'').toString().localeCompare((b[k]||''),'ru',{sensitivity:'base'});

    function extractUrl(val){
      if(!val) return '';
      if(typeof val === 'object'){ return sanitizeUrl(val.url || val.href || val.link || ''); }
      const s = String(val).trim();
      const md = s.match(/\[[^\]]*\]\(([^)]+)\)/);
      if(md && md[1]) return sanitizeUrl(md[1]);
      const ah = s.match(/href\s*=\s*["']([^"']+)["']/i);
      if(ah && ah[1]) return sanitizeUrl(ah[1]);
      return sanitizeUrl(s);
    }

    function sanitizeUrl(raw){
      if(!raw) return '';
      let u = String(raw).trim();
      u = u.replace(/^(https?):\/(?!\/)/i, (_,p)=>`${p}://`);
      if(!/^[a-z]+:\/\//i.test(u)){
        if(/^docs\.getgrist\.com\b/i.test(u) || /^[a-z0-9.-]+\.[a-z]{2,}\b/i.test(u)){ u = 'https://' + u; }
      }
      if(/^\s*javascript:/i.test(u) || /^\s*data:/i.test(u)) return '';
      try{
        const url = new URL(u);
        if(/(^|\.)docs\.getgrist\.com$/i.test(url.hostname)){
          if(!url.searchParams.has('embed')) url.searchParams.set('embed','true'); // чистый вид
          // style не трогаем (например, singlePage)
          return url.toString();
        }
      }catch(e){}
      return u;
    }

    const isGrist = (u)=>{ try{ return /(^|\.)docs\.getgrist\.com$/i.test(new URL(u).hostname) } catch{ return false } };

    function openSmart(u){
      if(!u) return;
      try{ if(isGrist(u) && window.top){ window.top.location.assign(u); return; } }catch(e){}
      window.open(u,'_blank','noopener');
    }

    function guessColumns(cols){
      const lc = cols.map(c=>c.toLowerCase());
      const pick = (cands) => {
        for(const cand of cands){
          let i = lc.indexOf(cand.toLowerCase()); if(i>-1) return cols[i];
          i = lc.findIndex(x=>x.includes(cand.toLowerCase())); if(i>-1) return cols[i];
        }
        return null;
      };
      return { name: pick(['Staff','Name','Сотрудник','ФИО']), role: pick(['Role','Должность','Роль']), link: pick(['Workspace_link','Workspace','Link','URL','Ссылка']) };
    }

    function normalizeRow(row, cols){
      const src = row;
      return { name: src?.[cols.name] ?? '', role: src?.[cols.role] ?? '', link: extractUrl(src?.[cols.link]) };
    }

    function render(records){
      const grid = el('#grid'); grid.innerHTML = '';
      if(!records?.length){ grid.innerHTML = `<div class="empty">Нет данных в таблице</div>`; return; }
      const tpl = el('#cardTpl');
      const frag = document.createDocumentFragment();
      records.forEach((r,i)=>{
        const card = tpl.content.firstElementChild.cloneNode(true);
        card.style.animationDelay = `${i*60}ms`;
        el('.name', card).textContent = r.name || '—';
        el('.role', card).textContent = r.role || '';
        const a = el('a.badge', card);
        if(r.link){ a.addEventListener('click', (e)=>{ e.preventDefault(); openSmart(r.link); }); } else { a.remove(); }
        frag.appendChild(card);
      });
      grid.appendChild(frag);
    }

    let ORIGINAL = []; let VISIBLE = [];
    function applySearchSort(){
      const q = el('#q').value.trim().toLowerCase();
      const sort = el('#sort').value;
      VISIBLE = ORIGINAL.filter(x => !q || (x.name+" "+x.role).toLowerCase().includes(q));
      VISIBLE.sort(by(sort==='role' ? 'role' : 'name'));
      render(VISIBLE);
    }
    function setupUX(){
      el('#q').addEventListener('input', applySearchSort);
      el('#sort').addEventListener('change', applySearchSort);
      window.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); el('#q').focus(); }});
    }

    async function init(){
      setupUX();
      if(!window.grist){
        ORIGINAL = [{name:'Phil',role:'Media Buyer',link:'#'},{name:'Tien',role:'Media Buyer',link:'#'},{name:'Thomas',role:'Team Lead',link:'#'}];
        applySearchSort(); return;
      }
      grist.ready({requiredAccess:'read table'});
      grist.onRecords((table)=>{
        const rows = (table.records||table).map(r=> r.fields ? r.fields : r);
        const cols = guessColumns(Object.keys(rows[0]||{}));
        ORIGINAL = rows.map(r=> normalizeRow(r, cols));
        applySearchSort();
      });
    }
    init();
  </script>
</body>
</html>
