<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Directory Widget</title>
  <!-- Load Grist Custom Widget API -->
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    /* Basic reset and typography */
    body { margin: 0; padding: 10px; background: #fff; color: #333; font-family: sans-serif; }
    /* Container for cards */
    #card-list { display: flex; flex-direction: column; gap: 10px; }
    /* Message (Loading/No data) text */
    #message { color: #555; font-style: italic; padding: 8px 0; }
    /* Card styling */
    .card {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px 12px;
      background: #fdfdfd;
      transition: background 0.3s ease;
    }
    .card:hover { background: #f8f8f8; }
    /* Name and role text */
    .name { font-weight: bold; font-size: 1.0em; }
    .role { color: #666; font-size: 0.9em; margin: 2px 0 8px; }
    /* Link badge styling */
    .workspace-link {
      display: inline-block;
      text-decoration: none;
      background: #eaeaea;
      color: #333;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 0.85em;
      white-space: nowrap;             /* keep text in one line */
      transition: background 0.2s;
    }
    .workspace-link:hover, .workspace-link:focus {
      background: #dcdcdc;
      color: #000;
    }
    /* Reduce motion: disable transitions if user prefers no animation */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { transition: none !important; animation: none !important; }
    }
  </style>
</head>
<body>
  <!-- Status/Message area -->
  <div id="message">Loading…</div>
  <!-- Container for cards -->
  <div id="card-list"></div>

  <script>
    // Notify Grist that the widget is ready to receive data (request read-table access)
    grist.ready({ requiredAccess: 'read table' });
    // Utility: normalize a Grist document URL to the required embed format
    function normalizeUrl(url) {
      try {
        const u = new URL(url);
        if (u.hostname !== "docs.getgrist.com") return url;
        // Ensure path has form /docId/slug, ignore any extra parts like /p/#
        const parts = u.pathname.replace(/^\/|\/$/g, "").split("/");
        if (parts.length < 2) return url;
        const [docId, slug] = parts;
        return `https://docs.getgrist.com/${docId}/${slug}/p/10?embed=true&style=singlePage`;
      } catch (e) {
        return url;
      }
    }
    // Subscribe to all records in the Buyers table
    grist.onRecords(function(records) {
      const messageEl = document.getElementById('message');
      const listEl = document.getElementById('card-list');
      // If no records, show "No data found"
      if (!records || records.length === 0) {
        messageEl.textContent = "No data found.";
        messageEl.style.display = "block";
        listEl.innerHTML = "";  // clear any existing cards
        return;
      }
      // We have data records; hide the "Loading…"/empty message
      messageEl.style.display = "none";
      listEl.innerHTML = "";  // clear previous entries
      // Create a card for each record
      for (const rec of records) {
        // Create card container
        const card = document.createElement('div');
        card.className = "card";
        // Name element
        const nameDiv = document.createElement('div');
        nameDiv.className = "name";
        nameDiv.textContent = rec.Staff ?? "";   // staff name
        card.appendChild(nameDiv);
        // Role element
        const roleDiv = document.createElement('div');
        roleDiv.className = "role";
        roleDiv.textContent = rec.Role ?? "";    // role text
        card.appendChild(roleDiv);
        // Link badge element
        const link = document.createElement('a');
        link.className = "workspace-link";
        link.textContent = "Open Workspace";
        // Normalize and set the hyperlink URL
        const url = rec.Workspace_URL || "";
        link.href = normalizeUrl(url);
        link.target = "_blank"; 
        link.rel = "noopener noreferrer";
        card.appendChild(link);
        // Append this card to the list
        listEl.appendChild(card);
      }
    });
  </script>
</body>
</html>
